---
name: data-cleaning-protocols
description: Regex patterns and coding standards for cleaning AI-generated quiz data (removing page numbers, prefixes, etc.).
---

# Data Cleaning Protocols

This skill documents the standard procedures for cleaning and polishing quiz data generated by AI. Use these patterns to ensure high-quality content display.

## 1. Text Sanitization (Python Pipeline)

Integrate these cleaning functions into your merge scripts (e.g., `merge_mental_v13.py`).

### Standard Cleaner Function
```python
import re

def clean_text(text):
    if not isinstance(text, str):
        return text
    
    # 1. Remove Page References: (P.123), (p.10), （P5）
    # Matches: Full/Half parens, P/p, optional dot, digits
    text = re.sub(r'[（\(][Pp][\.]?\d+[）\)]', '', text)
    
    # 2. Remove "※" notes if they are just metadata
    # text = re.sub(r'^※.*$', '', text, flags=re.MULTILINE)
    
    # 3. Trim extra whitespace
    text = text.strip()
    
    return text
```

### Usage in Merge Script
Apply this to all text fields before saving the JSON.
```python
for q in questions:
    q['question_text'] = clean_text(q.get('question_text'))
    q['explanation'] = clean_text(q.get('explanation'))
    q['options'] = [clean_text(opt) for opt in q.get('options', [])]
```

## 2. Category & Content Filtering

Reject invalid content at the source (Merge step).

### Bad Content Filter (The "No Meta" Rule)
Exclude questions that reference the textbook itself (e.g., "本書では...").

```python
NG_WORDS = [
    "本書", "教科書", "はじめに", "本章", "次節", "下記", "次の図", "図参照",
    "課程", "資料", "添付", "図", "グラフ", "表", "参照", "引用", "出典",
    "前項", "次項", "URL", "http"
]

def has_ng_word(q):
    txt = str(q.get('question_text', '')) + str(q.get('explanation', ''))
    for w in NG_WORDS:
        if w in txt:
            return True
    return False

# Filter
clean_questions = [q for q in questions if not has_ng_word(q)]
```

### Invalid Category Filter
- **Rule**: Exclude labels starting with "Book_" or "Mental_Special_...".
- **Rule**: Exclude generic placeholders like "精神専門".

## 3. UI Display Formatting (React Native)

Some cleaning is best done at runtime for display purposes.

### Removing "PSW Prefix"
In `app/folders/[group].tsx`:
```tsx
// Converts "PSW専6 ソーシャルワーク" -> "ソーシャルワーク"
<Text>{item.title.replace(/^PSW専\d+[ 　]*/, '')}</Text>
```

## 4. Quality Assurance Checklist
- [ ] Are `(P.xx)` references removed from explanations?
- [ ] Are category names readable (no `Book_001`)?
- [ ] Are duplicated questions minimized?
- [ ] Is the data structure consistent (id, options, answer)?
