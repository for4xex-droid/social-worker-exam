# データベース構造改革 顛末報告書 (2026-01-15)

## 1. 概要
社会福祉士アプリから精神保健福祉士アプリへの移行過程で発生した「データ消失」「カテゴリ混入」「システム干渉」に対し、根本的なデータベースアーキテクチャの刷新を行いました。
本レポートは、その問題詳細、解決策、および結果を記録するものです。

## 2. 発生していた問題
### 2.1 データ干渉と消失
- **事象**: 「精神保健福祉士」用にデータベースを最適化した結果、「社会福祉士」用の専門科目データが上書きされたり、検索不能になった。
- **原因**: 全資格のデータを単一の巨大ファイル (`master_data.json`) で管理しており、フラグ管理が複雑化していたため。また、バックアップファイル (`v3`, `v10`など) が乱立し、正本が不明確になっていた。

### 2.2 データ混入 (Contamination)
- **事象**: 社会福祉士用アプリに、精神保健福祉士専用の問題（精神医学の詳細な問題など）が表示される可能性があった。
- **原因**: 以前の分類ロジックが「キーワード検索（例：『医学』『リハビリ』）」に依存しており、共通性の高い単語を含む問題が誤って分類されていた。

### 2.3 生成パイプラインの不安定化
- **事象**: Python環境の不整合や標準出力のエンコーディング問題により、データ生成スクリプト (`prepare_web_assets.py`) が頻繁に停止した。
- **影響**: 開発効率の著しい低下と、デプロイに対する不信感。

---

## 3. 実施した対策

### 3.1 データベースの物理的分離 (Isolation)
データを論理的なタグ（`group_id`）だけで分けるのをやめ、**物理的に異なるファイル**として分割・再構築しました。

- **旧構成**:
  - `master_data.json` (全てのデータが混在。約15,000件)

- **新構成 (`app/assets/separated_db/`)**:
  - `master_social.json`: 社会福祉士＋共通科目 (12,905件)
  - `master_mental.json`: 精神保健福祉士＋共通科目 (11,629件)
  - `master_care.json`: 介護福祉士＋共通科目 (予備)

### 3.2 厳格な分類ロジック (Strict Tracing)
データの振り分けにおいて、曖昧な「キーワード」よりも、確実な「フォルダ痕跡（Source Trace）」を優先するロジックを導入しました。

- **手順**:
  1. 問題データの `source` や `id` に `SW専` (Social) や `精神専` (Mental) のコードが含まれているか確認。
  2. コードが確認できた場合、その資格専用として確定させる。
  3. キーワード判定は、コードがない場合のみ補助的に使用（かつ、誤検知しやすい汎用単語を除外）。

### 3.3 パイプラインの Node.js 化
不安定なPythonスクリプトを廃止し、Webアプリと同じ **Node.js** 環境で動作する堅牢なスクリプト群を開発しました。
- `reorganize_database.js`: データの収集・分離・保存
- `verify_separation_strict.js`: 相互混入のチェック（混入ゼロを保証）
- `prepare_web_assets_node.js`: アプリ用アセットの生成

---

## 4. 最終結果

### 4.1 データ統計
再構築後のデータ内訳は以下の通りです。
（※ 共通科目は各資格のDBに重複して含まれます）

| カテゴリ | 件数 | 備考 |
| :--- | :--- | :--- |
| **社会福祉士 専門科目** | **4,035問** | 純粋な専門科目のみ。混入なし。 |
| **精神保健福祉士 専門科目** | **2,759問** | 純粋な専門科目のみ。混入なし。 |
| **共通科目** | **8,870問** | 全資格で共有される基盤データ。 |
| **介護福祉士 専門科目** | **332問** | 将来用。 |

### 4.2 アプリとの連携
- **Web版**: `APP_VARIANT` 環境変数に基づき、対応する `master_*.json` からアセットを生成。
- **Nativeアプリ版**: `app.config.js` の `variant` 設定に基づき、起動時に正しい `master_*.json` を動的にインポートするよう修正済み。

---

## 5. 今後の開発における注意点 (Golden Rules)

1. **`master_data.json` を編集しない**:
   - 今後、データの追加や修正は `master_data.json` を直接いじるのではなく、ソースとなるファイルを追加し、`reorganize_database.js` を通して正規化してください。

2. **パイプラインを通す**:
   - データを変更した際は、必ず以下の **3ステップ** を実行してください。
     1. `node reorganize_database.js` (再構築)
     2. `node verify_separation_strict.js` (検証・安全確認)
     3. `node data_pipeline/prepare_web_assets_node.js` (反映)

3. **PythonよりNode.jsを優先**:
   - 環境依存のトラブルを避けるため、データ処理スクリプトはNode.jsでの実装を維持してください。

4. **新資格の追加時**:
   - `master_care.json` のように、必ず新しい独立したマスターファイルを定義してから開発に着手してください。既存ファイルへの相乗りは厳禁です。
