---
name: troubleshoot-data-sync
description: Troubleshoot issues with data synchronization between Python pipelines and the Expo app (missing data, zombie data).
---

# Data Sync Troubleshooting

This skill addresses issues where updated data (from Python scripts) fails to appear in the Expo app, or old "zombie" data persists.

## ðŸš¨ Symptoms
- New questions generated by Python scripts are not appearing in the App.
- Old or deleted categories (e.g., "Book_0001", "spec_mental") persist even after updates.
- "2 questions" or "0 questions" folders appear unexpectedly.

## ðŸ› ï¸ Root Cause Analysis & Solutions

### 1. Data Source Contamination (Dirty JSON)
- **Issue**: `generate_mental_large.py` appends to the JSON file. Old, buggy runs (e.g., missing category labels) stay in the file forever.
- **Fix**:
  - **Inspect**: Use a script to list all categories in `generated.json`.
  - **Filter**: Update the `merge` script to exclude "junk" patterns (e.g., `startswith("Book_")`).
  - **Clean**: If possible, delete `generated.json` and regenerate cleanly.

### 2. File Lock & Race Conditions
- **Issue**: Running the `merge` script while the `generate` script is writing can result in reading incomplete or cached old data.
- **Fix**:
  - **Stop generation** (Ctrl+C) before running the merge script.
  - Run the merge script to finalize the output file (e.g., `master_database_vXX.json`).

### 3. Database Persistence (The "Zombie DB")
- **Issue**: Expo SQLite databases persist on the device/simulator. `DROP TABLE` logic in `initializeDb` may be skipped due to hot-reloading timing or async race conditions.
- **Fix (The Nuclear Option)**:
  - **Change `DB_NAME`**: In `client.native.ts`, change the database filename (e.g., `v21.db` -> `v22.db`). This forces the app to create a fresh DB instance, bypassing all persistence issues.
  - **Uninstall**: Delete the Expo Go project entry or uninstall the app to clear SQLite files.

### 4. Bundler Caching
- **Issue**: Metro Bundler aggressively caches `require("...json")`. Even if the JSON content changes, the app might receive the old version.
- **Fix**:
  - **Rename JSON**: Change the output filename in the merge script and the `require` path in `client.native.ts` (e.g., `rev2.json` -> `rev3.json`). This invalidates all caches 100%.
  - Run Expo with `--clear`.

---

## âœ… Workflow for Guaranteed Update
If data is not updating, follow this sequence:

1. **Stop** the `generate` script (Ctrl+C).
2. **Verify** filters in the `merge` script (exclude junk categories).
3. **Run** the `merge` script.
4. **Update DB Name**: Change `DB_NAME` in `app/db/client.native.ts` (increment version).
5. **(Optional)** Update JSON Name: If unsure, rename the merged JSON file (e.g. `v13_revX`).
6. **Restart Server**:
   ```powershell
   $env:APP_VARIANT="mental"; npx expo start --clear --offline
   ```
7. **Scan QR** with a fresh start.
